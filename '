import type { AppRouteHandler } from '../../utils/open-api-types';
import type { UserCreateRoute, UserListRoute } from './users-routes';
import { JSend } from '@repo/http/jsend';
import { HttpStatus } from '@repo/http/status-codes';
import { UserQueries } from '../../db/queries/user-queries';
import { Password } from '../../utils/password';

export class UserHandlers {
	static list: AppRouteHandler<UserListRoute> = async (c) => {
		const users = await UserQueries.getUsers();
		return c.json(JSend.success(users, 'Succesfully got users.'), HttpStatus.OK);
	};

	static create: AppRouteHandler<UserCreateRoute> = async (c) => {
		const user = c.req.valid('json');

		const hashedPassword = await Password.hash(user.password);

		const existingUser = await UserQueries.getUserByEmail(user.email);
		if (existingUser) {
			return c.json(JSend.error('User already exists.'), HttpStatus.CONFLICT);
		}

		await UserQueries.createUser({ ...user, password: hashedPassword });
		return c.json(JSend.success({}, 'User created succesfully.'), HttpStatus.CREATED);
	};
}
